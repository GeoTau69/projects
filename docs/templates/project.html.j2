{# project.html.j2 ‚Äî Jinja2 ≈°ablona pro projektovou dokumentaci
   Vstup: doc (dict z JSON), built_at (string)
   V√Ωstup: statick√Ω HTML soubor. ≈Ω√°dn√© AI vol√°n√≠.
#}
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìñ {{ doc.display_name or doc.project }} ‚Äî Dokumentace</title>
<style>
{% include 'static/css/theme.css' %}

/* Override: build pipeline pou≈æ√≠v√° sans-serif font */
body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    line-height: 1.7;
    display: block;
}

/* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
.top-bar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}
.top-bar-title { font-size: 15px; font-weight: 600; }
.top-bar-meta  { font-size: 12px; color: var(--text2); display: flex; align-items: center; gap: 10px; }

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.layout {
    display: flex;
    max-width: 1400px;
    margin: 0 auto;
}

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
.sidebar {
    width: 260px;
    min-width: 260px;
    padding: 20px 16px;
    border-right: 1px solid var(--border);
    position: sticky;
    top: 52px;
    height: calc(100vh - 52px);
    overflow-y: auto;
}
.sidebar h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text2);
    margin: 16px 0 6px;
    padding: 0 12px;
}
.sidebar a {
    display: block;
    padding: 5px 12px;
    color: var(--text);
    text-decoration: none;
    font-size: 13px;
    border-radius: 6px;
    margin: 1px 0;
    transition: background 0.1s;
}
.sidebar a:hover { background: var(--bg3); color: var(--blue); }
.sidebar a.active { background: var(--bg3); color: var(--blue); }

/* ‚îÄ‚îÄ Hlavn√≠ obsah ‚îÄ‚îÄ */
.content {
    flex: 1;
    padding: 32px 48px;
    max-width: 900px;
}
h1 { font-size: 30px; margin-bottom: 6px; }
h2 {
    font-size: 21px;
    margin: 48px 0 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
    color: var(--blue);
    scroll-margin-top: 64px;
}
h3 { font-size: 16px; margin: 24px 0 8px; color: var(--text); }
p { margin-bottom: 12px; color: var(--text); }
ul, ol { margin: 8px 0 16px 24px; }
li { margin-bottom: 4px; }
a { color: var(--blue); text-decoration: none; }
a:hover { text-decoration: underline; }

code {
    background: var(--bg3);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 13px;
    color: var(--orange);
}
pre {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    overflow-x: auto;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 13px;
    line-height: 1.5;
    margin: 12px 0 20px;
    color: var(--text);
}

/* ‚îÄ‚îÄ Tabulky ‚îÄ‚îÄ */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0 20px;
    font-size: 14px;
}
th, td {
    padding: 9px 14px;
    border: 1px solid var(--border);
    text-align: left;
}
th { background: var(--bg3); font-weight: 600; color: var(--text2); }
tr:hover td { background: var(--bg2); }

/* ‚îÄ‚îÄ Back link ‚îÄ‚îÄ */
.btn-back {
    background: var(--blue);
    color: white !important;
    padding: 6px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    font-size: 13px;
}
.btn-back:hover { opacity: 0.85; text-decoration: none; }

{% include 'static/css/build.css' %}

@media (max-width: 900px) {
    .sidebar { display: none; }
    .content { padding: 20px 16px; }
}
</style>
</head>
<body>

{# ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ #}
<div class="top-bar">
    <div class="top-bar-title">
        üìñ {{ doc.display_name or doc.project }}{% if doc.version %} <span style="font-weight:400;color:var(--text2)">v{{ doc.version }}</span>{% endif %}
    </div>
    <div class="top-bar-meta">
        {% if doc.status %}
        <span class="badge badge-{{ 'green' if doc.status == 'active' else 'yellow' if doc.status == 'wip' else 'purple' if doc.status == 'planned' else 'red' }}">{{ doc.status }}</span>
        {% endif %}
        <span>Generov√°no {{ built_at }}</span>
        {% if doc.back_link %}
        <a href="{{ doc.back_link.href }}" class="btn-back">{{ doc.back_link.label }}</a>
        {% endif %}
    </div>
</div>

<div class="layout">

{# ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ #}
<nav class="sidebar">
    {% if doc.modules %}
    <h3>K√≥d</h3>
    <a href="#moduly">üì¶ Moduly</a>
    {% endif %}
    {% if doc.sections %}
    <h3>Dokumentace</h3>
    {% for section in doc.sections %}
    <a href="#{{ section.id }}">{% if section.icon %}{{ section.icon }} {% endif %}{{ section.title }}</a>
    {% endfor %}
    {% endif %}
</nav>

{# ‚îÄ‚îÄ Hlavn√≠ obsah ‚îÄ‚îÄ #}
<main class="content">

<h1>{{ doc.display_name or doc.project }}</h1>

{% if doc.description %}
<p style="color:var(--text2);font-size:15px;margin-bottom:8px;">{{ doc.description }}</p>
{% endif %}

<div class="meta-row">
    {% if doc.tech %}<span>‚öôÔ∏è {{ doc.tech | join(', ') }}</span>{% endif %}
    {% if doc.port %}<span>üîå port {{ doc.port }}</span>{% endif %}
    {% if doc.updated %}<span>üìÖ aktualizov√°no {{ doc.updated }}</span>{% endif %}
</div>

{% if doc.access %}
<table>
    <thead><tr><th>S√≠≈•</th><th>URL</th></tr></thead>
    <tbody>
    {% if doc.access.local %}
    <tr><td>Lok√°ln√≠</td><td><code>{{ doc.access.local }}</code></td></tr>
    {% endif %}
    {% if doc.access.lan %}
    <tr><td>LAN</td><td><code>{{ doc.access.lan }}</code></td></tr>
    {% endif %}
    {% if doc.access.tailscale %}
    <tr><td>Tailscale</td><td><code>{{ doc.access.tailscale }}</code></td></tr>
    {% endif %}
    </tbody>
</table>
{% endif %}

{# ‚ïê‚ïê K√≥dov√© moduly ‚ïê‚ïê #}
{% if doc.modules %}
<h2 id="moduly">üì¶ K√≥dov√© moduly</h2>

<table>
    <thead><tr><th>Modul</th><th>Soubor</th><th>√öƒçel</th><th>Status</th></tr></thead>
    <tbody>
    {% for m in doc.modules %}
    <tr>
        <td><strong>{{ m.name }}</strong></td>
        <td>{% if m.file %}<code>{{ m.file | e }}</code>{% else %}‚Äî{% endif %}</td>
        <td>{{ m.purpose }}</td>
        <td>
        {% if m.status == 'stable' %}<span class="badge badge-green">stable</span>
        {% elif m.status == 'beta' %}<span class="badge badge-yellow">beta</span>
        {% elif m.status == 'wip' %}<span class="badge badge-yellow">wip</span>
        {% elif m.status == 'deprecated' %}<span class="badge badge-red">deprecated</span>
        {% else %}<span class="badge badge-blue">{{ m.status }}</span>{% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

{% for m in doc.modules %}
{% if m.public_methods %}
<h3>
    {{ m.name }}
    {% if m.file %}<span style="font-size:13px;font-weight:400;color:var(--text2)">‚Äî <code>{{ m.file | e }}</code></span>{% endif %}
</h3>
{% if m.notes %}<p style="color:var(--text2);font-size:13px;">{{ m.notes }}</p>{% endif %}
<table>
    <thead><tr><th>Metoda</th><th>Parametry</th><th>Vrac√≠</th><th>Popis</th></tr></thead>
    <tbody>
    {% for method in m.public_methods %}
    <tr>
        <td><code>{{ method.name | e }}()</code></td>
        <td><code style="font-size:12px;">{{ (method.params or '‚Äî') | e }}</code></td>
        <td>{{ method.returns or '‚Äî' }}</td>
        <td>{{ method.description }}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% elif m.notes %}
<h3>{{ m.name }}</h3>
<p style="color:var(--text2);">{{ m.notes }}</p>
{% endif %}
{% endfor %}
{% endif %}

{# ‚ïê‚ïê Dokumentaƒçn√≠ sekce ‚ïê‚ïê #}
{% for section in doc.sections %}
<h2 id="{{ section.id }}">{% if section.icon %}{{ section.icon }} {% endif %}{{ section.title }}</h2>

{% for blk in section.blocks %}

{% if blk.type == 'text' %}
<p>{{ blk.text }}</p>

{% elif blk.type == 'heading' %}
<h3>{{ blk.text }}</h3>

{% elif blk.type == 'code' %}
<pre>{{ blk.text | e }}</pre>

{% elif blk.type == 'list' %}
{% if blk.ordered %}
<ol>
{% for item in blk.entries %}<li>{{ item }}</li>
{% endfor %}
</ol>
{% else %}
<ul>
{% for item in blk.entries %}<li>{{ item }}</li>
{% endfor %}
</ul>
{% endif %}

{% elif blk.type == 'table' %}
<table>
    <thead>
    <tr>{% for h in blk.headers %}<th>{{ h }}</th>{% endfor %}</tr>
    </thead>
    <tbody>
    {% for row in blk.rows %}
    <tr>{% for cell in row %}<td>{{ cell }}</td>{% endfor %}</tr>
    {% endfor %}
    </tbody>
</table>

{% elif blk.type == 'live_status' %}
<div class="live-status">
    <h3>
        <span class="pulse"></span>
        Live Project Status
        <button onclick="updateLiveStatus()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:13px;margin-left:8px;" title="Aktualizovat">üîÑ</button>
    </h3>
    <p>Aktu√°ln√≠ stav syst√©mu &nbsp;|&nbsp; Kliknƒõte üîÑ pro aktualizaci</p>
    <div class="status-grid">
        <div class="status-item"><div class="status-item-label">Dashboard</div><div class="status-item-value ok" id="status-dashboard">‚óè Running</div></div>
        <div class="status-item"><div class="status-item-label">Snapper Snapshoty</div><div class="status-item-value" id="status-snapshots">‚Äî</div></div>
        <div class="status-item"><div class="status-item-label">Borg Archivy</div><div class="status-item-value" id="status-borg">‚Äî</div></div>
        <div class="status-item"><div class="status-item-label">Backup Disk</div><div class="status-item-value" id="status-disk">‚Äî</div></div>
        <div class="status-item"><div class="status-item-label">Root Disk</div><div class="status-item-value" id="status-root">‚Äî</div></div>
        <div class="status-item"><div class="status-item-label">Posledn√≠ Borg</div><div class="status-item-value" id="status-last-borg">‚Äî</div></div>
        <div class="status-item"><div class="status-item-label">Posledn√≠ Sync</div><div class="status-item-value" id="status-last-sync">‚Äî</div></div>
        <div class="status-item"><div class="status-item-label">Health Status</div><div class="status-item-value" id="status-health">‚Äî</div></div>
    </div>
    <div style="margin-top:16px;font-size:13px;color:var(--text2);">
        <strong>Posledn√≠ update:</strong> <span id="status-timestamp">‚Äî</span>
    </div>
</div>
<script>
async function updateLiveStatus() {
    const set = (id, text, cls) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = text;
        el.className = 'status-item-value' + (cls ? ' ' + cls : '');
    };
    try {
        const r = await fetch('{{ blk.api_endpoint }}');
        const data = await r.json();
        if (data.snapshots?.count !== undefined) set('status-snapshots', data.snapshots.count, 'ok');
        if (data.borg?.count !== undefined) set('status-borg', data.borg.count, 'ok');
        if (data.backup_disk) {
            if (data.backup_disk.mounted)
                set('status-disk', data.backup_disk.used_percent + '% pou≈æito', data.backup_disk.used_percent > 85 ? 'warn' : 'ok');
            else
                set('status-disk', '‚ö† Unmounted', 'error');
        }
        if (data.root_disk)
            set('status-root', data.root_disk.used_percent + '% pou≈æito', data.root_disk.used_percent > 85 ? 'warn' : 'ok');
        if (data.borg?.last_backup) set('status-last-borg', data.borg.last_backup, 'ok');
        if (data.sync?.last_run) set('status-last-sync', data.sync.last_run, 'ok');
        if (data.warnings !== undefined)
            set('status-health', data.warnings.length === 0 ? '‚úì OK' : '‚ö† ' + data.warnings.length + ' varov√°n√≠', data.warnings.length === 0 ? 'ok' : 'warn');
        document.getElementById('status-timestamp').textContent = new Date().toLocaleString('cs-CZ');
    } catch(e) {
        set('status-dashboard', '‚ö† Offline', 'error');
    }
}
updateLiveStatus();
</script>

{% elif blk.type == 'card' %}
<div class="card-doc {{ blk.variant or '' }}">
    <div class="card-title">{{ blk.title }}</div>
    {% if blk.text %}<p>{{ blk.text }}</p>{% endif %}
    {% if blk.entries %}
    <ul>
    {% for item in blk.entries %}<li>{{ item }}</li>
    {% endfor %}
    </ul>
    {% endif %}
    {% if blk.code %}<pre>{{ blk.code | e }}</pre>{% endif %}
</div>

{% endif %}
{% endfor %}
{% endfor %}

</main>
</div>

<script>
{% include 'static/js/sidebar-scroll.js' %}
</script>

</body>
</html>
